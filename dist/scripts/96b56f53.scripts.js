"use strict";angular.module("snapplrApp",["ngCookies","ngSanitize"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("snapplrApp").run(["$rootScope","$log",function(a,b){a.currentUser=Userbin.user(),b.info("User:",Userbin.user()),Userbin.on("login.success login.error logout.success",function(){a.currentUser=Userbin.user(),a.$apply()})}]).controller("MainCtrl",["$scope","$log","$http","mapFactory",function(a,b,c){a.$log=b,a.$http=c,a.starredFeatures={},a.saveFeature=function(b,c){a.currentUser&&(a.starredFeatures[b]||(a.starredFeatures[b]=c,a.$apply()))},a.$watch("starredFeatures",function(){b.info("new features",a.starredFeatures)}),a.reset=function(){return Userbin.user()?(Userbin.user().set("snapplr",{}).done(function(){Userbin.user().get("snapplr").done(function(b){var c=b.snapplr;a.starredFeatures=c,a.$apply()})}),void 0):!1};var d=function(){return a.starredFeatures=[],a.$$phase||a.$apply(),Userbin.user()?(Userbin.user().get("snapplr").done(function(b){a.starredFeatures=b.snapplr,a.$apply()}),void 0):!1};d(),Userbin.on("login.success logout.success",function(){d()})}]).directive("leaflet",["mapFactory","Auth","$window",function(a,b,c){return{restrict:"A",link:function(b,d){var e=b.$log,f=b.$http;a.setMap(L.map(d[0]).setView([55.61,13],16)),a.setJQuery($);var g="25eefd22fc3a4f58b056285afbec54dc",h=a.getMap();L.tileLayer("http://{s}.tile.cloudmade.com/"+g+"/112595/256/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',maxZoom:18}).addTo(h),L.grid().addTo(h),h.on("click",function(d){b.isLoading=0;var g=d.latlng;L.circle([g.lat,g.lng],10,{color:"red",fillColor:"#f03",fillOpacity:.5}).addTo(a.getMap());var h="http://snapplr.sb01.stations.graphenedb.com:24789/db/data/",i=h+"cypher",j=h+"ext/SpatialPlugin/graphdb/findClosestGeometries",k=c.btoa("snapplr:zki1hvIvPp491lDzvmiV");f.defaults.headers.common.Authorization="Basic "+k,e.info("auth",k),e.info("http",f.defaults),b.isLoading++,f.post(j,{layer:"malmo_small_map.osm",pointX:g.lng,pointY:g.lat,distanceInKm:5e-4}).then(function(c){if(b.isLoading--,0==c.data.length)return alert("no features found"),void 0;for(var d={color:"#2262CC",weight:2,opacity:.6,fillOpacity:.1,fillColor:"#2262CC"},g={color:"#00FF00",weight:3,opacity:.6,fillOpacity:.1,fillColor:"#2262CC"},h={color:"#FF0000",weight:3,opacity:.6,fillOpacity:.65,fillColor:"#2262CC"},j=0;j<c.data.length;j++){var k=c.data[j].self.substr(c.data[0].self.lastIndexOf("/")+1),l="start n=node("+k+") match n<-[:GEOM]-feature-[:FIRST_NODE]->first-[:NEXT*..]->next-[:NODE]->osm_node,  feature-[:TAGS]->tags where tags.name IS NOT NULL return id(feature) as feature_id,osm_node.lat,osm_node.lon, tags.name? as name, tags.highway? as highway, tags, feature";a.getJQuery(),b.isLoading++,f.post(i,{query:l,params:{id:k}}).then(function(c){b.isLoading--;var f=c.data.data,i=a.getMap(),j=[];if(f.length>0){for(var k=f[0][0],l=f[0][3],m=f[0][4],n=0;n<f.length;n++)j.push([f[n][1],f[n][2]]);var o=L.polygon(j,d);m&&(o=L.polyline(j,g));var p="feature_id";angular.element(o).attr(p,k),i.addLayer(o),o.on("click",function(a){var c=a.target.feature_id;b.saveFeature(c,l),e.info("saving",b.starredFeatures),Userbin.user().set("snapplr",angular.copy(b.starredFeatures))}),o.on("mouseover",function(a){var c=a.target.options;a.target.setStyle(h);var d=angular.element("#details");d.html("Name : "+l+"<br/>ID: "+angular.element(o).attr(p)),b.starredFeatures[k]&&d.append("<br><i class='fa fa-star'></i> starred "),o.on("mouseout",function(a){a.target.setStyle(c)})})}},function(){b.isLoading--})}})})}}}]).factory("mapFactory",function(){var a=null,b=null;return{setMap:function(b){a=b},getMap:function(){return a},setJQuery:function(a){b=a},getJQuery:function(){return b}}}).factory("Auth",["$window","$http","$log",function(a,b,c){return{setCredentials:function(d,e){var f=a.btoa(d+":"+e);c.info("auth",f),b.defaults.headers.common.Authorization="Basic "+f}}}]);